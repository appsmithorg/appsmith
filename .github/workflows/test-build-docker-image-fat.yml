name: Test fat, build and push Docker Image

on:
  # This line enables manual triggering of this workflow.
  workflow_dispatch:

jobs:
  build:
#    permissions:
#      issues: write
    runs-on: ubuntu-latest
    steps:
      - name: Load docker image
        env:
          APPSMITH_LICENSE_KEY: ${{ secrets.APPSMITH_LICENSE_KEY }}
        if: success() && github.ref == 'refs/heads/release' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
        working-directory: "."
        run: |
          mkdir -p fatcontainerlocal/stacks/configuration/
          cd fatcontainerlocal
          docker run -d --name appsmith -p 80:80 -p 9001:9001 \
            -v "$PWD/stacks:/appsmith-stacks" appsmith/appsmith-ce
          sudo chmod a+rw stacks/configuration/docker.env
          sudo echo  "APPSMITH_LICENSE_KEY=$APPSMITH_LICENSE_KEY" >> stacks/configuration/docker.env
          sudo cat stacks/configuration/docker.env
            
      
      - name: Restart Appsmith
        if: steps.run_result.outputs.run_result != 'success'
        run: |
          docker restart appsmith
