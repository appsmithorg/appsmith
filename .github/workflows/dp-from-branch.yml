name: Build and Push image from branch ( To be used by ops.appsmith.com API layer only)

on:
  # This workflow is only triggered by the `/build-deploy-preview` command dispatch
  workflow_dispatch:
    inputs:
      branch:
        description: "Github Branch to be deployed"
        required: true
        default: "release"
      skip-tests:
        description: "Flag to skip tests durin build"
        required: true
        default: "release"
      uid:
        description: "Unique ID to store the run data in the db"
        required: true
      sub-domain-name:
        description: "Sub-domain for dp.appsmith.com to by used by this deploy preview (This will also be the image name and the k8s namespace identifier)"
        required: true

jobs:
  write-job-details-to-db:
    runs-on: ubuntu-latest
    steps:
      - name: Install mongosh
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -
          echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-mongosh
      - name: Update job data to mongoDB
        run: |
          #  mongosh 'mongodb+srv://appsmithadmin:W58w5yCN6ZY5Y42A@appsmith-infra-test-clu.zljea.mongodb.net/appsmiht-ce-github-dp-runs' --eval 'db.appsmiht-ce-github-dp-runs.insert( { run_id: ${{ github.run_id }}, uid: ${{ github.event.inputs.uid }}, status: "Started" } )'
          mongosh 'mongosh 'mongodb+srv://appsmithadmin:W58w5yCN6ZY5Y42A@appsmith-infra-test-clu.zljea.mongodb.net/appsmiht-ce-github-dp-runs' --eval 'db.appsmiht-ce-github-dp-runs.update(
                                                                  { _id:  ${{ github.event.inputs.uid }} },
                                                                  {
                                                                    $set: {
                                                                      run_id: ${{ github.run_id }},
                                                                      status: "BUILD IN PROGRESS"
                                                                    }
                                                                  }
                                                                )'
          #TODO Add mongo URI as secret
            
