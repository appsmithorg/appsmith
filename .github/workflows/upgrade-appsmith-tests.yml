name: Debug ci-merge-check

on:
  #This workflow is only triggered by the ok to test command dispatch
  workflow_dispatch:
    
jobs:
   ci-merge-check:
    runs-on: ubuntu-latest
    steps:
      # This step creates a comment on the PR with a link to this workflow run.
      # - name: Add a comment on the PR with link to workflow run
      #   uses: peter-evans/create-or-update-comment@v2
      #   with:
      #     issue-number: ${{ github.event.client_payload.pull_request.number }}
      #     body: |
      #             found ci-merge-check ${{ github.event.client_payload.pull_request.number }}
      
      # Timestamp will be used to create cache key
      - name: timestamp
        run: echo "timestamp=$(date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Find the latest workflow run comment
        uses: peter-evans/find-comment@v2
        id: find-comment
        with:
          issue-number: 22062
          body-includes: 'Tests running at:'
          direction: last
      
      - name: Get the workflow run_id
        id: workflow
        run: |
          echo "run_id= $(echo '${{ steps.find-comment.outputs.comment-body }}' | grep -o 'runs/[0-9]\+' | cut -d/ -f2)" >> $GITHUB_OUTPUT
      
      - name: Get ci-test-result status from the run_id
        id: ci-test-result-status
        run: |
          run_status=`curl --silent https://api.github.com/repos/appsmithorg/appsmith/actions/runs/${{ steps.workflow.outputs.run_id }}/jobs?per_page=100|jq -r '[ .jobs[] | select(.name | contains("ci-test-result")) | .conclusion ]'|grep -v  '\[\|\]'|sed "s/\"//g"|sed "s/ //g"`
          echo "run_status= $run_status" >> $GITHUB_OUTPUT

      - run: |
          echo ${{ steps.ci-test-result-status.outputs.run_status }}
