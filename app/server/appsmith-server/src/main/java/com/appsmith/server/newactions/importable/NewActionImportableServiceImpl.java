package com.appsmith.server.newactions.importable;

import com.appsmith.external.models.ActionDTO;
import com.appsmith.server.actioncollections.base.ActionCollectionService;
import com.appsmith.server.domains.Application;
import com.appsmith.server.domains.NewAction;
import com.appsmith.server.dtos.MappedImportableResourcesDTO;
import com.appsmith.server.imports.importable.ImportableService;
import com.appsmith.server.imports.importable.artifactbased.ArtifactBasedImportableService;
import com.appsmith.server.newactions.base.NewActionService;
import org.springframework.stereotype.Service;

import java.util.Map;
import java.util.stream.Collectors;

import static java.lang.Boolean.TRUE;

@Service
public class NewActionImportableServiceImpl extends NewActionImportableServiceCEImpl
        implements ImportableService<NewAction> {

    public NewActionImportableServiceImpl(
            NewActionService newActionService,
            ActionCollectionService actionCollectionService,
            ArtifactBasedImportableService<NewAction, Application> applicationImportableService) {
        super(newActionService, actionCollectionService, applicationImportableService);
    }

    @Override
    protected NewAction getExistingActionInCurrentBranchForImportedAction(
            MappedImportableResourcesDTO mappedImportableResourcesDTO,
            Map<String, NewAction> actionsInCurrentApp,
            NewAction newAction) {
        if (!Boolean.TRUE.equals(newAction.getIsPublic())) {
            return super.getExistingActionInCurrentBranchForImportedAction(
                    mappedImportableResourcesDTO, actionsInCurrentApp, newAction);
        }
        Map<String, NewAction> fQNToNewActionMap = actionsInCurrentApp.values().stream()
                .collect(Collectors.toMap(
                        existingAction -> existingAction.getUnpublishedAction().getValidName(),
                        newAction1 -> newAction1,
                        (u, v) -> u));

        return fQNToNewActionMap.get(newAction.getUnpublishedAction().getValidName());
    }

    @Override
    protected boolean existingArtifactContainsAction(Map<String, NewAction> actionsInCurrentApp, NewAction newAction) {
        return super.existingArtifactContainsAction(actionsInCurrentApp, newAction)
                || (Boolean.TRUE.equals(newAction.getIsPublic())
                        && actionsInCurrentApp.values().stream().anyMatch(newAction1 -> newAction
                                .getUnpublishedAction()
                                .getValidName()
                                .equals(newAction1.getUnpublishedAction().getValidName())));
    }

    @Override
    protected void populateDomainMappedReferences(
            MappedImportableResourcesDTO mappedImportableResourcesDTO, NewAction newAction) {
        super.populateDomainMappedReferences(mappedImportableResourcesDTO, newAction);
        if (TRUE.equals(newAction.getIsPublic())) {
            ActionDTO unpublishedAction = newAction.getUnpublishedAction();
            ActionDTO publishedAction = newAction.getPublishedAction();
            // This public action had not been created with module instance,
            // this would happen in the case of orphan module instances.
            // Go ahead and set the references to instance now
            Map<String, String> moduleInstanceRefToIdMap = mappedImportableResourcesDTO.getModuleInstanceRefToIdMap();
            newAction.setRootModuleInstanceId(moduleInstanceRefToIdMap.get(newAction.getRootModuleInstanceId()));
            newAction.setModuleInstanceId(moduleInstanceRefToIdMap.get(newAction.getModuleInstanceId()));
            unpublishedAction.setDatasource(null);
            unpublishedAction.autoGenerateDatasource();
            publishedAction.setDatasource(null);
            publishedAction.autoGenerateDatasource();
        }
    }

    @Override
    protected void updateImportableActionFromExistingAction(NewAction existingAction, NewAction actionToImport) {
        super.updateImportableActionFromExistingAction(existingAction, actionToImport);

        actionToImport.setModuleInstanceId(existingAction.getModuleInstanceId());
        actionToImport.setRootModuleInstanceId(existingAction.getRootModuleInstanceId());
    }
}
